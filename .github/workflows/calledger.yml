name: Test
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Restore FTP Deploy Cache
        uses: actions/cache@v4
        with:
          path: .ftp-deploy-sync-state.json
          key: ${{ runner.os }}-ftp-${{ github.ref }}
          restore-keys: |
            ${{ runner.os }}-ftp-
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.AWS_HOST }} >> ~/.ssh/known_hosts
      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ubuntu@${{ secrets.AWS_HOST }} "echo âœ… SSH connection successful!"
             
             - name: ðŸš€ Deploy Laravel app to EC2 
              run: |
                echo "ðŸš€ Deploying Laravel app to EC2..."

    
    # Sync files from GitHub runner to EC2
rsync -avz -e "ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no" \--exclude ".git" --exclude "node_modules" --exclude ".github" \./ ubuntu@${{ secrets.AWS_HOST }}:/var/www/myapp 

     # Run post-deploy commands on EC2
    ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ubuntu@${{ secrets.AWS_HOST }} << 'EOF'
      echo "âœ… Connected to EC2 â€” running deployment steps..."

      # Set permissions
      sudo chown -R ubuntu:www-data /var/www/myapp
      sudo chmod -R 775 /var/www/myapp

      # Go to app directory
      cd /var/www/myapp

      # (Optional) Update repository if youâ€™re using git pull inside EC2
      # git pull origin main

      # Ensure composer is available and optimize Laravel
      composer install --no-dev --optimize-autoloader
      php artisan migrate --force
      php artisan optimize
      php artisan config:cache
      php artisan route:cache
      php artisan view:cache

      echo "âœ… Laravel app deployed successfully!"
    EOF

